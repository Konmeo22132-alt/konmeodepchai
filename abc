repeat task.wait() until game:IsLoaded() and game.Players.LocalPlayer
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CoreGui = game:GetService("CoreGui")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer
if not getgenv().Config then
    getgenv().Config = { Weapon = "Melee", Boss = "Rip Indra", Team = "Marines" }
end
local PLACE_WORLD = { World1 = 2753915549, World2 = 4442272183, World3 = 7449423635 }
local function currentWorld()
    local pid = game.PlaceId
    if pid == PLACE_WORLD.World1 then return "World1" end
    if pid == PLACE_WORLD.World2 then return "World2" end
    if pid == PLACE_WORLD.World3 then return "World3" end
    return nil
end
local function targetWorldForBoss(bossName)
    local n = string.lower(tostring(bossName))
    if n:find("rip") then return "World3" end
    if n:find("dough") then return "World3" end
    if n:find("cursed") then return "World2" end
    return nil
end
local MeleeList = {
    "Combat","Dark Step","Electric","Water Kung Fu","Dragon Breath",
    "Super Human","Death Step","Sharkman Karate","Electric Claw",
    "Dragon Talon","Godhuman","Sanguine Art"
}
local function HasItem(name)
    for _,v in pairs(LocalPlayer.Backpack:GetChildren()) do if v.Name==name then return true end end
    for _,v in pairs(LocalPlayer.Character and LocalPlayer.Character:GetChildren() or {}) do if v.Name==name then return true end end
    return false
end
local function EquipPreferred()
    local char = LocalPlayer.Character
    if not char then return end
    local backpack = LocalPlayer.Backpack
    if getgenv().Config.Weapon == "Melee" then
        for _,m in ipairs(MeleeList) do
            if backpack:FindFirstChild(m) then pcall(function() char.Humanoid:EquipTool(backpack[m]) end) return end
            if char:FindFirstChild(m) then return end
        end
    elseif getgenv().Config.Weapon == "Sword" then
        for _,tool in ipairs(backpack:GetChildren()) do
            if tool:IsA("Tool") and tool.ToolTip == "Sword" then pcall(function() char.Humanoid:EquipTool(tool) end) return end
        end
    end
end
local function TrySelectTeam(teamName)
    pcall(function()
        if not teamName then return end
        local tn = tostring(teamName)
        local ok, _ = pcall(function() ReplicatedStorage.Remotes.CommF_:InvokeServer("SetTeam", tn) end)
        if not ok then
            pcall(function() ReplicatedStorage.Remotes.CommF_:InvokeServer("join"..tn) end)
        end
    end)
end
local function AutoHaki()
    pcall(function() if LocalPlayer.Character and not LocalPlayer.Character:FindFirstChild("HasBuso") then ReplicatedStorage.Remotes.CommF_:InvokeServer("Buso") end end)
end
local function topos(cf)
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then pcall(function() LocalPlayer.Character.HumanoidRootPart.CFrame = cf end) end
end
local function safeClick()
    pcall(function() game:GetService("VirtualUser"):CaptureController() game:GetService("VirtualUser"):Button1Down(Vector2.new()) end)
end
local function FastAttackOnModel(model, yOffset)
    spawn(function()
        while model and model.Parent and model:FindFirstChild("Humanoid") and model.Humanoid.Health > 0 do
            task.wait(0.1)
            pcall(function()
                AutoHaki()
                EquipPreferred()
                local char = LocalPlayer.Character
                if not char then return end
                if model:FindFirstChild("HumanoidRootPart") then
                    model.HumanoidRootPart.CanCollide = false
                    pcall(function() model.Humanoid.WalkSpeed = 0 end)
                    local offset = CFrame.new(0, (yOffset or 15), 0)
                    local targetCFrame = model.HumanoidRootPart.CFrame * offset
                    topos(targetCFrame)
                    pcall(function() char.HumanoidRootPart.AssemblyLinearVelocity = Vector3.new(0,0,0) end)
                    local weapon
                    for _,it in ipairs(char:GetChildren()) do if it:IsA("Tool") then weapon = it break end end
                    if weapon and weapon:FindFirstChild("LeftClickRemote") then
                        local dir = (model.HumanoidRootPart.Position - char:GetPivot().Position).Unit
                        pcall(function() weapon.LeftClickRemote:FireServer(dir,1) end)
                    else
                        local ok,atk = pcall(function() return ReplicatedStorage.Modules.Net["RE/RegisterAttack"] end)
                        local ok2,hit = pcall(function() return ReplicatedStorage.Modules.Net["RE/RegisterHit"] end)
                        pcall(function()
                            if atk then atk:FireServer(0.1) end
                            if hit and model:FindFirstChild("Head") then hit:FireServer(model.Head, {{model, model.Head}}) end
                        end)
                    end
                end
            end)
        end
    end)
end
local function FarmAndBuyEctoplasmLoop()
    spawn(function()
        while HasItem("Hellfire Torch") do
            local args1 = {"Ectoplasm","BuyCheck",4}
            local args2 = {"Ectoplasm","Change",4}
            pcall(function() ReplicatedStorage.Remotes.CommF_:InvokeServer(unpack(args1)) end)
            task.wait(0.5)
            pcall(function() ReplicatedStorage.Remotes.CommF_:InvokeServer(unpack(args2)) end)
            task.wait(0.5)
        end
    end)
    local mobs = {["Ship Deckhand"]=true,["Ship Engineer"]=true,["Ship Steward"]=true,["Ship Officer"]=true}
    local farmPos = CFrame.new(911.35827636719,125.95812988281,33159.5390625)
    while HasItem("Hellfire Torch") do
        for _,mob in ipairs(Workspace.Enemies:GetChildren()) do
            if mob and mob.Name and mobs[mob.Name] and mob:FindFirstChild("Humanoid") and mob.Humanoid.Health>0 then
                repeat task.wait(0.1)
                    AutoHaki()
                    EquipPreferred()
                    if mob:FindFirstChild("HumanoidRootPart") then
                        mob.HumanoidRootPart.CanCollide=false
                        pcall(function() mob.Humanoid.WalkSpeed=0 end)
                        local targetCFrame = mob.HumanoidRootPart.CFrame * CFrame.new(0,18,0)
                        topos(targetCFrame)
                        pcall(function() LocalPlayer.Character.HumanoidRootPart.AssemblyLinearVelocity = Vector3.new(0,0,0) end)
                        safeClick()
                    end
                until not mob.Parent or mob.Humanoid.Health<=0 or not HasItem("Hellfire Torch")
            end
        end
        topos(farmPos)
        task.wait(0.5)
    end
end
local JOBFILE = "JobIds.txt"
local function jobidAlreadyUsed(id)
    if isfile and isfile(JOBFILE) then
        local s = readfile(JOBFILE)
        for line in s:gmatch("[^\r\n]+") do if line == id then return true end end
    end
    return false
end
local function appendJobId(id)
    if writefile then
        if isfile and isfile(JOBFILE) then
            local s = readfile(JOBFILE)
            writefile(JOBFILE, (s .. "\n" .. id))
        else
            writefile(JOBFILE, id)
        end
    end
end
local function GetApiBossList()
    local ok, res = pcall(function() return game:HttpGet("https://konmeo22132.vercel.app/api/boss") end)
    if not ok or not res then return {} end
    local ok2, data = pcall(function() return HttpService:JSONDecode(res) end)
    if not ok2 or type(data) ~= "table" then return {} end
    table.sort(data, function(a,b) return (a.expireTime or 0) > (b.expireTime or 0) end)
    return data
end
local function findMatchingRecords(data, bossName)
    local res = {}
    for _,v in ipairs(data) do
        if v and v.Type == "Boss" and v.Name and string.lower(v.Name) == string.lower(bossName) then
            if v.Jobid and v.Jobid ~= "" and not jobidAlreadyUsed(v.Jobid) then table.insert(res, v) end
        end
    end
    table.sort(res, function(a,b) return (a.expireTime or 0) > (b.expireTime or 0) end)
    return res
end
local function HopToJobInstance(jobid)
    local ok,err = pcall(function() TeleportService:TeleportToPlaceInstance(game.PlaceId, jobid, LocalPlayer) end)
    if ok then appendJobId(jobid) end
    return ok, err
end
local function TeleportToWorld(placeId)
    pcall(function() TeleportService:Teleport(placeId, LocalPlayer) end)
end
local function uiCreate()
    local gui = Instance.new("ScreenGui")
    gui.ResetOnSpawn = false
    gui.IgnoreGuiInset = true
    gui.Name = "HuneIPA_HopBoss_UI"
    local frame = Instance.new("Frame", gui)
    frame.Size = UDim2.new(0,320,0,140)
    frame.Position = UDim2.new(0.02,0,0.02,0)
    frame.BackgroundColor3 = Color3.fromRGB(30,30,30)
    frame.BackgroundTransparency = 0.35
    frame.BorderSizePixel = 0
    local corner = Instance.new("UICorner", frame)
    corner.CornerRadius = UDim.new(0,8)
    local outline = Instance.new("Frame", gui)
    outline.Size = UDim2.new(0,324,0,144)
    outline.Position = UDim2.new(0.019,0,0.019,0)
    outline.BackgroundColor3 = Color3.fromRGB(34,177,76)
    local title = Instance.new("TextLabel", frame)
    title.Size = UDim2.new(1,0,0,30)
    title.Position = UDim2.new(0,0,0,6)
    title.Text = "HuneIPA - Hop Boss"
    title.TextColor3 = Color3.fromRGB(34,177,76)
    title.BackgroundTransparency = 1
    title.TextStrokeTransparency = 0
    title.TextStrokeColor3 = Color3.fromRGB(0,0,0)
    title.Font = Enum.Font.SourceSansBold
    title.TextSize = 18
    local bossLabel = Instance.new("TextLabel", frame)
    bossLabel.Size = UDim2.new(1,0,0,22)
    bossLabel.Position = UDim2.new(0,0,0,40)
    bossLabel.Text = "Boss: "..tostring(getgenv().Config.Boss)
    bossLabel.TextColor3 = Color3.fromRGB(34,177,76)
    bossLabel.BackgroundTransparency = 1
    bossLabel.TextStrokeTransparency = 0
    bossLabel.TextStrokeColor3 = Color3.fromRGB(0,0,0)
    bossLabel.Font = Enum.Font.SourceSans
    bossLabel.TextSize = 16
    local status = Instance.new("TextLabel", frame)
    status.Size = UDim2.new(1,0,0,68)
    status.Position = UDim2.new(0,0,0,64)
    status.Text = "Status: Idle"
    status.TextColor3 = Color3.fromRGB(34,177,76)
    status.BackgroundTransparency = 1
    status.TextWrapped = true
    status.TextStrokeTransparency = 0
    status.TextStrokeColor3 = Color3.fromRGB(0,0,0)
    status.Font = Enum.Font.SourceSans
    status.TextSize = 14
    gui.Parent = CoreGui
    return {Gui = gui, Frame = frame, Title = title, BossLabel = bossLabel, Status = status}
end
local UI_OBJ = uiCreate()
local function uiSetStatus(s)
    pcall(function() UI_OBJ.Status.Text = "Status: "..s end)
end
local function uiSetFoundServer(jobid, serverName)
    pcall(function()
        UI_OBJ.Status.Text = "Found server. Hopping"
        local t = Instance.new("TextLabel", UI_OBJ.Frame)
        t.Size = UDim2.new(1,0,0,32)
        t.Position = UDim2.new(0,0,0,100)
        t.Text = "Jobid (New server): ".. tostring(jobid) .. " | Server: ".. tostring(serverName)
        t.TextColor3 = Color3.fromRGB(34,177,76)
        t.BackgroundTransparency = 1
        t.TextWrapped = true
        t.TextSize = 12
        t.Font = Enum.Font.SourceSans
        delay(5,function() pcall(function() t:Destroy() end) end)
    end)
end
local function pickAndHopFromApi()
    uiSetStatus("Finding server...")
    local data = GetApiBossList()
    if #data == 0 then uiSetStatus("No API data") return false end
    local recs = findMatchingRecords(data, getgenv().Config.Boss)
    if #recs == 0 then uiSetStatus("No matching boss in API") return false end
    for _,rec in ipairs(recs) do
        uiSetStatus("Found server. Hopping")
        uiSetFoundServer(rec.Jobid, rec.Server or "Unknown")
        local ok,err = HopToJobInstance(rec.Jobid)
        if ok then return true end
    end
    uiSetStatus("No available jobid to hop")
    return false
end
local function ensureWorldAndHop()
    local targetW = targetWorldForBoss(getgenv().Config.Boss)
    if targetW then
        local cw = currentWorld()
        if cw ~= targetW then
            uiSetStatus("Teleporting to "..targetW)
            local pid = PLACE_WORLD[targetW]
            if pid then TeleportToWorld(pid) return true end
        end
    end
    local hopped = pickAndHopFromApi()
    return hopped
end
spawn(function()
    TrySelectTeam(getgenv().Team)
    while task.wait(3) do
        if not getgenv().Config or not getgenv().Config.Boss then task.wait(1) end
        local succeeded = ensureWorldAndHop()
        if succeeded then break end
    end
end)
Workspace.Enemies.ChildRemoved:Connect(function(child)
    if not child or not child.Name then return end
    local cfg = tostring(getgenv().Config.Boss)
    if string.lower(cfg):find("rip") then
        if child.Name == "rip_indra" or child.Name == "rip_indra True Form" then
            uiSetStatus("Boss died")
        end
    elseif string.lower(cfg):find("dough") then
        if child.Name == "Dough King" then uiSetStatus("Boss died") end
    elseif string.lower(cfg):find("cursed") then
        if child.Name == "Cursed Captain" then
            uiSetStatus("Boss died")
            if HasItem("Hellfire Torch") then
                task.wait(2)
                uiSetStatus("Farm Ectoplasm...")
                FarmAndBuyEctoplasmLoop()
            end
        end
    end
end)
spawn(function()
    while task.wait(0.8) do
        local bossName = tostring(getgenv().Config.Boss)
        if currentWorld() == "World3" then
            if string.find(string.lower(bossName),"rip") then
                local b = Workspace.Enemies:FindFirstChild("rip_indra True Form") or Workspace.Enemies:FindFirstChild("rip_indra")
                if b and b.Parent and b:FindFirstChild("Humanoid") and b.Humanoid.Health>0 then
                    uiSetStatus("Attack boss")
                    FastAttackOnModel(b, 35)
                    repeat task.wait(1) until not b.Parent or b.Humanoid.Health<=0
                    task.wait(0.6)
                    topos(CFrame.new(-2009.28,4532.972,-14937.308))
                end
            elseif string.find(string.lower(bossName),"dough") then
                local b = Workspace.Enemies:FindFirstChild("Dough King")
                if b and b.Parent and b:FindFirstChild("Humanoid") and b.Humanoid.Health>0 then
                    uiSetStatus("Attack boss")
                    FastAttackOnModel(b, 35)
                    repeat task.wait(1) until not b.Parent or b.Humanoid.Health<=0
                    task.wait(0.6)
                    topos(CFrame.new(-2009.28,4532.972,-14937.308))
                else
                    topos(CFrame.new(-2009.28,4532.972,-14937.308))
                end
            end
        elseif currentWorld() == "World2" then
            if string.find(string.lower(bossName),"cursed") then
                local b = Workspace.Enemies:FindFirstChild("Cursed Captain")
                if b and b.Parent and b:FindFirstChild("Humanoid") and b.Humanoid.Health>0 then
                    uiSetStatus("Attack boss")
                    FastAttackOnModel(b, 45)
                    repeat task.wait(1) until not b.Parent or b.Humanoid.Health<=0
                    task.wait(0.8)
                    if HasItem("Hellfire Torch") then
                        uiSetStatus("Farm Ectoplasm...")
                        FarmAndBuyEctoplasmLoop()
                    end
                    topos(CFrame.new(923,125,32853))
                else
                    uiSetStatus("Going to Cursed Ship")
                    topos(CFrame.new(923,125,32853))
                end
            end
        end
    end
end)
