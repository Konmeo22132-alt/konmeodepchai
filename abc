repeat task.wait() until game:IsLoaded() and game.Players.LocalPlayer
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local Workspace = game:GetService("Workspace")
if not getgenv().Config then
    getgenv().Config = { Weapon = "Melee", Boss = "Rip Indra" }
end
local PLACE_WORLD = {
    World1 = 2753915549,
    World2 = 4442272183,
    World3 = 7449423635
}
local function currentWorld()
    local pid = game.PlaceId
    if pid == PLACE_WORLD.World1 then return "World1" end
    if pid == PLACE_WORLD.World2 then return "World2" end
    if pid == PLACE_WORLD.World3 then return "World3" end
    return nil
end
local function targetWorldForBoss(bossName)
    local n = string.lower(bossName)
    if n == "rip indra" or n == "rip_indra" or n == "rip_indra true form" or n == "rip_indra trueform" then
        return "World3"
    elseif n == "dough king" or n == "dough_king" then
        return "World3"
    elseif n == "cursed captain" or n == "cursed_captain" then
        return "World2"
    end
    return nil
end
local MeleeList = {
    "Combat","Dark Step","Electric","Water Kung Fu","Dragon Breath",
    "Super Human","Death Step","Sharkman Karate","Electric Claw",
    "Dragon Talon","Godhuman","Sanguine Art"
}
local function HasItem(name)
    for _,v in pairs(LocalPlayer.Backpack:GetChildren()) do if v.Name==name then return true end end
    for _,v in pairs(LocalPlayer.Character and LocalPlayer.Character:GetChildren() or {}) do if v.Name==name then return true end end
    return false
end
local function EquipPreferred()
    local char = LocalPlayer.Character
    if not char then return end
    local backpack = LocalPlayer.Backpack
    if getgenv().Config.Weapon == "Melee" then
        for _,m in ipairs(MeleeList) do
            if backpack:FindFirstChild(m) then
                pcall(function() char.Humanoid:EquipTool(backpack[m]) end)
                return
            elseif char:FindFirstChild(m) then
                return
            end
        end
    elseif getgenv().Config.Weapon == "Sword" then
        for _,tool in ipairs(backpack:GetChildren()) do
            if tool:IsA("Tool") and tool.ToolTip == "Sword" then
                pcall(function() char.Humanoid:EquipTool(tool) end)
                return
            end
        end
    end
end
local function AutoHaki()
    pcall(function()
        if LocalPlayer.Character and not LocalPlayer.Character:FindFirstChild("HasBuso") then
            ReplicatedStorage.Remotes.CommF_:InvokeServer("Buso")
        end
    end)
end
local function topos(cf)
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        pcall(function() LocalPlayer.Character.HumanoidRootPart.CFrame = cf end)
    end
end
local function safeClick()
    pcall(function()
        game:GetService("VirtualUser"):CaptureController()
        game:GetService("VirtualUser"):Button1Down(Vector2.new())
    end)
end
local function FastAttackOnModel(model)
    spawn(function()
        while model and model.Parent and model:FindFirstChild("Humanoid") and model.Humanoid.Health > 0 do
            task.wait(0.1)
            pcall(function()
                AutoHaki()
                EquipPreferred()
                local char = LocalPlayer.Character
                if not char then return end
                if model:FindFirstChild("HumanoidRootPart") then
                    model.HumanoidRootPart.CanCollide = false
                    pcall(function() model.Humanoid.WalkSpeed = 0 end)
                    topos(model.HumanoidRootPart.CFrame * CFrame.new(0,10,0))
                    local weapon
                    for _,it in ipairs(char:GetChildren()) do if it:IsA("Tool") then weapon = it break end end
                    if weapon and weapon:FindFirstChild("LeftClickRemote") then
                        local dir = (model.HumanoidRootPart.Position - char:GetPivot().Position).Unit
                        pcall(function() weapon.LeftClickRemote:FireServer(dir,1) end)
                    else
                        local ok,atk = pcall(function() return ReplicatedStorage.Modules.Net["RE/RegisterAttack"] end)
                        local ok2,hit = pcall(function() return ReplicatedStorage.Modules.Net["RE/RegisterHit"] end)
                        pcall(function()
                            if atk then atk:FireServer(0.1) end
                            if hit and model:FindFirstChild("Head") then
                                hit:FireServer(model.Head, {{model, model.Head}})
                            end
                        end)
                    end
                end
            end)
        end
    end)
end
local function FarmAndBuyEctoplasmLoop()
    spawn(function()
        while HasItem("Hellfire Torch") do
            local args1 = {"Ectoplasm","BuyCheck",4}
            local args2 = {"Ectoplasm","Change",4}
            pcall(function() ReplicatedStorage.Remotes.CommF_:InvokeServer(unpack(args1)) end)
            task.wait(0.5)
            pcall(function() ReplicatedStorage.Remotes.CommF_:InvokeServer(unpack(args2)) end)
            task.wait(0.5)
        end
    end)
    local mobs = {["Ship Deckhand"]=true,["Ship Engineer"]=true,["Ship Steward"]=true,["Ship Officer"]=true}
    local farmPos = CFrame.new(911.35827636719,125.95812988281,33159.5390625)
    while HasItem("Hellfire Torch") do
        for _,mob in ipairs(Workspace.Enemies:GetChildren()) do
            if mob and mob.Name and mobs[mob.Name] and mob:FindFirstChild("Humanoid") and mob.Humanoid.Health>0 then
                repeat task.wait(0.1)
                    AutoHaki()
                    EquipPreferred()
                    if mob:FindFirstChild("HumanoidRootPart") then
                        mob.HumanoidRootPart.CanCollide=false
                        pcall(function() mob.Humanoid.WalkSpeed=0 end)
                        topos(mob.HumanoidRootPart.CFrame*CFrame.new(0,10,0))
                        safeClick()
                    end
                until not mob.Parent or mob.Humanoid.Health<=0 or not HasItem("Hellfire Torch")
            end
        end
        topos(farmPos)
        task.wait(0.5)
    end
end
local JOBFILE = "JobId.txt"
local function jobidAlreadyUsed(id)
    if isfile and isfile(JOBFILE) then
        local s = readfile(JOBFILE)
        for line in s:gmatch("[^\r\n]+") do
            if line == id then return true end
        end
    end
    return false
end
local function appendJobId(id)
    if writefile then
        local s = ""
        if isfile and isfile(JOBFILE) then s = readfile(JOBFILE) .. "\n" end
        writefile(JOBFILE, (s .. id .. "\n"))
    end
end
local function GetApiBossList()
    local ok, res = pcall(function() return game:HttpGet("https://konmeo22132.vercel.app/api/boss") end)
    if not ok or not res then return {} end
    local ok2, data = pcall(function() return HttpService:JSONDecode(res) end)
    if not ok2 or type(data) ~= "table" then return {} end
    table.sort(data, function(a,b) return (a.expireTime or 0) > (b.expireTime or 0) end)
    return data
end
local function findMatchingRecords(data, bossName)
    local res = {}
    local target = string.lower(bossName)
    for _,v in ipairs(data) do
        if v and v.Type == "Boss" and v.Name and string.lower(v.Name) == string.lower(bossName) then
            if v.Jobid and v.Jobid ~= "" and not jobidAlreadyUsed(v.Jobid) then
                table.insert(res, v)
            end
        end
    end
    table.sort(res, function(a,b) return (a.expireTime or 0) > (b.expireTime or 0) end)
    return res
end
local function HopToJobInstance(jobid)
    local ok,err = pcall(function()
        TeleportService:TeleportToPlaceInstance(game.PlaceId, jobid, LocalPlayer)
    end)
    if ok then
        appendJobId(jobid)
    end
    return ok, err
end
local function TeleportToWorld(placeId)
    pcall(function() TeleportService:Teleport(placeId, LocalPlayer) end)
end
local function pickAndHopFromApi()
    local data = GetApiBossList()
    if #data == 0 then return false end
    local recs = findMatchingRecords(data, getgenv().Config.Boss)
    if #recs == 0 then return false end
    for _,rec in ipairs(recs) do
        local ok,err = HopToJobInstance(rec.Jobid)
        if ok then return true end
    end
    return false
end
local function ensureWorldAndHop()
    local targetW = targetWorldForBoss(getgenv().Config.Boss)
    if targetW then
        local cw = currentWorld()
        if cw ~= targetW then
            local pid = PLACE_WORLD[targetW]
            if pid then
                TeleportToWorld(pid)
                return true
            end
        end
    end
    local hopped = pickAndHopFromApi()
    return hopped
end
spawn(function()
    while task.wait(3) do
        if not getgenv().Config or not getgenv().Config.Boss then task.wait(1) end
        local succeeded = ensureWorldAndHop()
        if succeeded then break end
    end
end)
local function AttackLoopController()
    while task.wait(0.8) do
        local bossName = getgenv().Config.Boss
        if not bossName then task.wait(1) end
        if currentWorld() == "World3" then
            if string.lower(bossName) == "rip indra" or string.lower(bossName) == "rip_indra" then
                local b = Workspace.Enemies:FindFirstChild("rip_indra True Form") or Workspace.Enemies:FindFirstChild("rip_indra")
                if b and b.Parent and b:FindFirstChild("Humanoid") and b.Humanoid.Health>0 then
                    FastAttackOnModel(b)
                    repeat task.wait(1) until not b.Parent or b.Humanoid.Health<=0
                end
            elseif string.lower(bossName) == "dough king" then
                local b = Workspace.Enemies:FindFirstChild("Dough King")
                if b and b.Parent and b:FindFirstChild("Humanoid") and b.Humanoid.Health>0 then
                    FastAttackOnModel(b)
                    repeat task.wait(1) until not b.Parent or b.Humanoid.Health<=0
                else
                    topos(CFrame.new(-2009.28,4532.972,-14937.308))
                end
            end
        elseif currentWorld() == "World2" then
            if string.lower(bossName) == "cursed captain" then
                local b = Workspace.Enemies:FindFirstChild("Cursed Captain")
                if b and b.Parent and b:FindFirstChild("Humanoid") and b.Humanoid.Health>0 then
                    FastAttackOnModel(b)
                    repeat task.wait(1) until not b.Parent or b.Humanoid.Health<=0
                    task.wait(1)
                    if HasItem("Hellfire Torch") then
                        FarmAndBuyEctoplasmLoop()
                    end
                else
                    topos(CFrame.new(923,125,32853))
                end
            end
        end
    end
end
spawn(AttackLoopController)
